services:
  proxy-machine:
    image: ghcr.io/patrickhere/proxy-machine:latest
    container_name: proxy-machine
    restart: unless-stopped

    # Required for Tailscale
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun

    ports:
      - "0.0.0.0:5001:5001"

    environment:
      - WEB_HOST=0.0.0.0
      - WEB_PORT=5001
      - LOG_LEVEL=INFO
      - MAX_DOWNLOAD_WORKERS=8
      - DEFAULT_PPI=600
      - DB_CACHE_SIZE_MB=200
      - PROXY_MACHINE_ROOT=/app
      - SHARED_ROOT=/data/shared
      - PROFILES_ROOT=/data/profiles
      - BULK_DATA_DIR=/data/bulk-data
      - REPORTS_DIR=/data/shared/reports
      - PDF_OUTPUT_DIR=/data/pdfs
      - TAILSCALE_ENABLED=true
      - TAILSCALE_HOSTNAME=proxy-machine
      # Set these in Unraid's Docker Compose plugin env section:
      # TAILSCALE_AUTHKEY=your-key
      # ADMIN_PASSWORD=your-password

    volumes:
      - ./data/shared:/data/shared
      - ./data/profiles:/data/profiles
      - ./data/bulk-data:/data/bulk-data
      - ./data/pdfs:/data/pdfs
      - ./data/logs:/app/logs
      - ./data/tailscale:/var/lib/tailscale

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
