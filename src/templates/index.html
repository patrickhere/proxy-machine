{% extends "base.html" %}

{% block content %}
<div x-data="{
    selectedProfile: '',
    selectedDeck: '',
    showAdvanced: false,
    message: '',
    messageType: '',
    isGenerating: false,
    showDeckImport: false,
    deckImportText: '',

    showMessage(text, type) {
        this.message = text;
        this.messageType = type;
        setTimeout(() => { this.message = ''; }, 5000);
    }
}" class="space-y-6">

    <!-- Alert Messages -->
    <div x-show="message" x-cloak
         :class="messageType === 'success' ? 'bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800 text-green-800 dark:text-green-200' : 'bg-red-50 dark:bg-red-900/30 border-red-200 dark:border-red-800 text-red-800 dark:text-red-200'"
         class="rounded-lg border p-4 shadow-sm transition-colors">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg x-show="messageType === 'success'" class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <svg x-show="messageType === 'error'" class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium" x-text="message"></p>
            </div>
            <div class="ml-auto pl-3">
                <button @click="message = ''" class="inline-flex rounded-md p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span class="sr-only">Dismiss</span>
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions Grid -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Profile & Deck Management -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden transition-colors">
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 dark:from-purple-900/30 dark:to-indigo-900/30 px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Profile & Deck Management</h2>
                    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Manage your proxy card collections</p>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Profile Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Profile</label>
                        <select id="profileSelect" x-model="selectedProfile"
                                @change="loadDecks()"
                                class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 text-base">
                            <option value="">Loading profiles...</option>
                        </select>
                    </div>

                    <!-- Deck List with Actions -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Decks</label>
                            <button @click="showDeckImport = !showDeckImport"
                                    class="text-sm text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300">
                                <span x-text="showDeckImport ? 'Cancel Import' : 'Import Deck List'"></span>
                            </button>
                        </div>

                        <!-- Deck Import Panel -->
                        <div x-show="showDeckImport" x-cloak x-transition class="mb-4 p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg border border-purple-200 dark:border-purple-800">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Paste deck list (MTGA format supported)</label>
                            <textarea x-model="deckImportText" rows="6" placeholder="4 Lightning Bolt&#10;4 Counterspell&#10;2 Island&#10;..."
                                      class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 text-sm"></textarea>
                            <div class="mt-3 flex gap-2">
                                <input type="text" id="importDeckName" placeholder="Deck name..."
                                       class="flex-1 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-purple-500 focus:ring-purple-500 text-sm">
                                <button @click="importDeck()"
                                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
                                    Import & Fetch Cards
                                </button>
                            </div>
                        </div>

                        <div id="deckList"
                             class="rounded-lg border border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-900/50 min-h-[200px] transition-colors">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Select a profile to view decks</p>
                        </div>
                    </div>

                    <!-- Create New Deck -->
                    <div class="flex gap-3">
                        <input type="text" id="newDeckName" placeholder="New deck name..."
                               class="flex-1 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-purple-500 focus:ring-purple-500">
                        <button @click="createDeck()"
                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-colors font-medium">
                            Create Deck
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="space-y-6">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 transition-colors">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">System Status</h3>
                <div class="mt-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600 dark:text-gray-300">Database</span>
                        <span class="inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/50 px-2.5 py-0.5 text-xs font-medium text-green-800 dark:text-green-300">
                            Ready
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600 dark:text-gray-300">Scryfall API</span>
                        <span class="inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/50 px-2.5 py-0.5 text-xs font-medium text-green-800 dark:text-green-300">
                            Connected
                        </span>
                    </div>
                </div>
            </div>

            <!-- Background Tasks -->
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 transition-colors">
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-4">Recent Tasks</h3>
                <div class="space-y-3" id="taskList">
                    {% for task in tasks[-5:] %}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-gray-600 dark:text-gray-300 truncate">{{ task.name }}</span>
                        <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium
                                   {% if task.status == 'completed' %}bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300{% elif task.status == 'running' %}bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300{% else %}bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300{% endif %}">
                            {{ task.status }}
                        </span>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No recent tasks</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Generation -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden transition-colors">
        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-indigo-900/30 dark:to-blue-900/30 px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Generate PDF</h2>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Create print-ready proxy PDFs</p>
        </div>
        <div class="p-6 space-y-6">
            <!-- Basic Options -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deck (Optional)</label>
                    <select id="deckSelect" x-model="selectedDeck"
                            class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">All cards (no deck filter)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">PDF Name (Optional)</label>
                    <input type="text" id="pdfName" placeholder="Auto-generated if empty"
                           class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>

            <!-- Advanced Options Toggle -->
            <div>
                <button @click="showAdvanced = !showAdvanced"
                        class="flex items-center text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300">
                    <svg :class="showAdvanced ? 'rotate-90' : ''" class="mr-2 h-4 w-4 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    <span x-text="showAdvanced ? 'Hide' : 'Show'"></span> Advanced Options
                </button>
            </div>

            <!-- Advanced Options -->
            <div x-show="showAdvanced" x-cloak x-transition class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Card Size</label>
                    <select id="cardSize" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                        <option value="standard">Standard (2.5" x 3.5")</option>
                        <option value="poker">Poker</option>
                        <option value="bridge">Bridge</option>
                        <option value="tarot">Tarot</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Paper Size</label>
                    <select id="paperSize" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                        <option value="letter">Letter (8.5" x 11")</option>
                        <option value="a4">A4</option>
                        <option value="tabloid">Tabloid</option>
                        <option value="a3">A3</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Crop (mm)</label>
                    <input type="number" id="crop" value="3.0" step="0.5" min="0" max="10"
                           class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">PPI (Quality)</label>
                    <input type="number" id="ppi" value="600" step="100" min="300" max="1200"
                           class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">JPEG Quality</label>
                    <input type="number" id="quality" value="100" min="50" max="100"
                           class="block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm">
                </div>
                <div class="flex items-end">
                    <label class="flex items-center">
                        <input type="checkbox" id="onlyFronts"
                               class="rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Only fronts (no backs)</span>
                    </label>
                </div>
            </div>

            <!-- Generate Button with Loading State -->
            <div class="flex justify-end">
                <button @click="generatePDF()" :disabled="isGenerating"
                        :class="isGenerating ? 'opacity-50 cursor-not-allowed' : ''"
                        class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-lg hover:from-indigo-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition-all font-semibold shadow-lg flex items-center gap-2">
                    <svg x-show="isGenerating" class="spinner h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="isGenerating ? 'Generating...' : 'Generate PDF'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Tools -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Database Sync -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 transition-colors">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Database Management</h3>
            <div class="space-y-3">
                <form method="POST" action="/run">
                    <input type="hidden" name="action" value="fetch_basics">
                    <button type="submit"
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm font-medium text-left">
                        Sync Basic Lands
                    </button>
                </form>
                <form method="POST" action="/run">
                    <input type="hidden" name="action" value="fetch_nonbasics">
                    <button type="submit"
                            class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm font-medium text-left">
                        Sync Non-Basic Lands
                    </button>
                </form>
            </div>
        </div>

        <!-- Tools -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 transition-colors">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Tools</h3>
            <div class="space-y-3">
                <a href="/coverage"
                   class="block w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm font-medium text-center">
                    View Coverage Reports
                </a>
                <a href="/unique_art"
                   class="block w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm font-medium text-center">
                    Unique Artwork Explorer
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function loadProfiles() {
    fetch('/api/profiles')
        .then(r => r.json())
        .then(data => {
            const select = document.getElementById('profileSelect');
            select.innerHTML = '<option value="">Select profile...</option>';
            data.profiles.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
        });
}

function loadDecks() {
    const profile = document.getElementById('profileSelect').value;
    const list = document.getElementById('deckList');

    if (!profile) {
        list.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Select a profile to view decks</p>';
        return;
    }

    list.innerHTML = '<div class="flex items-center justify-center py-4"><svg class="spinner h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>';

    fetch(`/api/profiles/${profile}/decks`)
        .then(r => r.json())
        .then(data => {
            if (data.decks.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No decks found. Create one above!</p>';
            } else {
                let html = '<div class="space-y-2">';
                data.decks.forEach(deck => {
                    html += `
                        <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-purple-300 dark:hover:border-purple-600 transition-colors group">
                            <div class="flex-1 min-w-0">
                                <span class="font-medium text-gray-900 dark:text-white">${deck.name}</span>
                                <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">${deck.card_count} cards</span>
                            </div>
                            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="viewDeck('${deck.name}')" class="p-1 text-gray-400 hover:text-purple-600 dark:hover:text-purple-400" title="View deck">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteDeck('${deck.name}')" class="p-1 text-gray-400 hover:text-red-600 dark:hover:text-red-400" title="Delete deck">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                list.innerHTML = html;
            }

            // Update deck select
            const deckSelect = document.getElementById('deckSelect');
            deckSelect.innerHTML = '<option value="">All cards (no deck filter)</option>';
            data.decks.forEach(deck => {
                deckSelect.innerHTML += `<option value="${deck.name}">${deck.name} (${deck.card_count} cards)</option>`;
            });
        });
}

function createDeck() {
    const profile = document.getElementById('profileSelect').value;
    const deckName = document.getElementById('newDeckName').value.trim();

    if (!profile || !deckName) {
        showGlobalMessage('Please select a profile and enter a deck name', 'error');
        return;
    }

    fetch(`/api/profiles/${profile}/decks`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({deck_name: deckName})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showGlobalMessage(data.error, 'error');
        } else {
            showGlobalMessage(`Deck "${deckName}" created!`, 'success');
            document.getElementById('newDeckName').value = '';
            loadDecks();
        }
    });
}

function importDeck() {
    const profile = document.getElementById('profileSelect').value;
    const deckName = document.getElementById('importDeckName').value.trim();
    const deckList = Alpine.$data(document.querySelector('[x-data]')).deckImportText.trim();

    if (!profile) {
        showGlobalMessage('Please select a profile first', 'error');
        return;
    }
    if (!deckName) {
        showGlobalMessage('Please enter a deck name', 'error');
        return;
    }
    if (!deckList) {
        showGlobalMessage('Please paste a deck list', 'error');
        return;
    }

    showGlobalMessage('Importing deck and fetching cards...', 'success');

    fetch(`/api/profiles/${profile}/import-deck`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({deck_name: deckName, deck_list: deckList})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            showGlobalMessage(data.error, 'error');
        } else {
            showGlobalMessage(`Deck "${deckName}" imported! ${data.cards_found || 0} cards found.`, 'success');
            document.getElementById('importDeckName').value = '';
            Alpine.$data(document.querySelector('[x-data]')).deckImportText = '';
            Alpine.$data(document.querySelector('[x-data]')).showDeckImport = false;
            loadDecks();
        }
    });
}

function viewDeck(deckName) {
    // TODO: Implement deck viewer modal
    showGlobalMessage(`Viewing deck: ${deckName}`, 'success');
}

function deleteDeck(deckName) {
    if (!confirm(`Delete deck "${deckName}"? This cannot be undone.`)) return;

    const profile = document.getElementById('profileSelect').value;
    // TODO: Implement deck deletion API
    showGlobalMessage(`Delete not yet implemented for: ${deckName}`, 'error');
}

function generatePDF() {
    const profile = document.getElementById('profileSelect').value;
    if (!profile) {
        showGlobalMessage('Please select a profile first', 'error');
        return;
    }

    const alpine = Alpine.$data(document.querySelector('[x-data]'));
    alpine.isGenerating = true;

    const payload = {
        deck: document.getElementById('deckSelect').value || null,
        pdf_name: document.getElementById('pdfName').value.trim() || null,
        card_size: document.getElementById('cardSize').value,
        paper_size: document.getElementById('paperSize').value,
        crop: parseFloat(document.getElementById('crop').value),
        ppi: parseInt(document.getElementById('ppi').value),
        quality: parseInt(document.getElementById('quality').value),
        only_fronts: document.getElementById('onlyFronts').checked
    };

    fetch(`/api/profiles/${profile}/pdf`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        alpine.isGenerating = false;
        if (data.error) {
            showGlobalMessage(data.error, 'error');
        } else {
            showGlobalMessage('PDF generation started! Check tasks below.', 'success');
            setTimeout(() => location.reload(), 3000);
        }
    })
    .catch(err => {
        alpine.isGenerating = false;
        showGlobalMessage('Failed to start PDF generation', 'error');
    });
}

function showGlobalMessage(text, type) {
    const alpine = Alpine.$data(document.querySelector('[x-data]'));
    if (alpine) {
        alpine.showMessage(text, type);
    }
}

// Load profiles on page load
document.addEventListener('DOMContentLoaded', () => {
    loadProfiles();
});
</script>
{% endblock %}
