{% extends "base.html" %}

{% block content %}
<div x-data="dashboard()" class="space-y-8">

    <!-- Hero Section with Search -->
    <section class="card-frame corner-flourish p-4 sm:p-8">
        <div class="text-center mb-6 sm:mb-8">
            <h2 class="font-display text-2xl sm:text-3xl md:text-4xl font-semibold text-mana-gold mb-2">Arcane Card Search</h2>
            <p class="text-arcanum-muted text-base sm:text-lg">Discover cards from across the multiverse</p>
        </div>

        <!-- Search Input -->
        <div class="max-w-2xl mx-auto mb-6 sm:mb-8">
            <div class="relative">
                <input type="text"
                       x-model="searchQuery"
                       @input.debounce.300ms="performSearch()"
                       @keydown.enter="performSearch()"
                       placeholder="Search cards..."
                       class="w-full px-4 sm:px-6 py-3 sm:py-4 bg-arcanum-deep border border-arcanum-border rounded-xl text-base sm:text-lg text-arcanum-text placeholder-arcanum-muted focus:border-mana-gold/50 transition-colors pr-12">
                <button @click="performSearch()"
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-arcanum-muted hover:text-mana-gold transition-colors">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mana Color Filters -->
        <div class="flex flex-wrap justify-center gap-2 sm:gap-3 mb-6">
            <button @click="toggleColor('W')"
                    :class="colors.includes('W') ? 'ring-2 ring-offset-2 ring-offset-arcanum-surface ring-mana-white scale-110' : 'opacity-60 hover:opacity-100'"
                    class="mana-btn bg-gradient-to-br from-mana-white to-amber-200 text-arcanum-void shadow-lg"
                    title="White">W</button>
            <button @click="toggleColor('U')"
                    :class="colors.includes('U') ? 'ring-2 ring-offset-2 ring-offset-arcanum-surface ring-mana-blue scale-110' : 'opacity-60 hover:opacity-100'"
                    class="mana-btn bg-gradient-to-br from-mana-blue to-blue-400 text-white shadow-lg"
                    title="Blue">U</button>
            <button @click="toggleColor('B')"
                    :class="colors.includes('B') ? 'ring-2 ring-offset-2 ring-offset-arcanum-surface ring-purple-500 scale-110' : 'opacity-60 hover:opacity-100'"
                    class="mana-btn bg-gradient-to-br from-gray-900 to-purple-950 text-gray-300 shadow-lg border border-purple-800"
                    title="Black">B</button>
            <button @click="toggleColor('R')"
                    :class="colors.includes('R') ? 'ring-2 ring-offset-2 ring-offset-arcanum-surface ring-mana-red scale-110' : 'opacity-60 hover:opacity-100'"
                    class="mana-btn bg-gradient-to-br from-mana-red to-orange-500 text-white shadow-lg"
                    title="Red">R</button>
            <button @click="toggleColor('G')"
                    :class="colors.includes('G') ? 'ring-2 ring-offset-2 ring-offset-arcanum-surface ring-mana-green scale-110' : 'opacity-60 hover:opacity-100'"
                    class="mana-btn bg-gradient-to-br from-mana-green to-emerald-400 text-white shadow-lg"
                    title="Green">G</button>
            <button @click="toggleColor('C')"
                    :class="colors.includes('C') ? 'ring-2 ring-offset-2 ring-offset-arcanum-surface ring-mana-colorless scale-110' : 'opacity-60 hover:opacity-100'"
                    class="mana-btn bg-gradient-to-br from-mana-colorless to-gray-400 text-arcanum-void shadow-lg"
                    title="Colorless">C</button>
        </div>

        <!-- Advanced Filters Toggle -->
        <div class="flex justify-center">
            <button @click="showFilters = !showFilters"
                    class="flex items-center gap-2 px-4 py-2 text-sm text-arcanum-muted hover:text-mana-gold transition-colors font-display tracking-wide">
                <svg :class="showFilters ? 'rotate-180' : ''" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
                <span x-text="showFilters ? 'Hide Filters' : 'Advanced Filters'"></span>
            </button>
        </div>

        <!-- Advanced Filters Panel -->
        <div x-show="showFilters" x-cloak x-transition class="mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-arcanum-border">
            <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 max-w-3xl mx-auto">
                <!-- Card Type -->
                <div>
                    <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">CARD TYPE</label>
                    <select x-model="cardType" @change="performSearch()"
                            class="w-full px-3 py-2 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text text-sm">
                        <option value="">Any Type</option>
                        <option value="creature">Creature</option>
                        <option value="instant">Instant</option>
                        <option value="sorcery">Sorcery</option>
                        <option value="enchantment">Enchantment</option>
                        <option value="artifact">Artifact</option>
                        <option value="planeswalker">Planeswalker</option>
                        <option value="land">Land</option>
                    </select>
                </div>

                <!-- Rarity -->
                <div>
                    <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">RARITY</label>
                    <select x-model="rarity" @change="performSearch()"
                            class="w-full px-3 py-2 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text text-sm">
                        <option value="">Any Rarity</option>
                        <option value="mythic">Mythic Rare</option>
                        <option value="rare">Rare</option>
                        <option value="uncommon">Uncommon</option>
                        <option value="common">Common</option>
                    </select>
                </div>

                <!-- CMC -->
                <div>
                    <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">MANA VALUE</label>
                    <select x-model="cmc" @change="performSearch()"
                            class="w-full px-3 py-2 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text text-sm">
                        <option value="">Any Cost</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7+">7+</option>
                    </select>
                </div>

                <!-- Set -->
                <div>
                    <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">SET CODE</label>
                    <input type="text" x-model="setCode" @input.debounce.300ms="performSearch()"
                           placeholder="e.g. MH3"
                           class="w-full px-3 py-2 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text text-sm placeholder-arcanum-muted">
                </div>
            </div>

            <!-- Clear Filters -->
            <div class="flex justify-center mt-4">
                <button @click="clearFilters()"
                        class="text-sm text-arcanum-muted hover:text-mana-red transition-colors">
                    Clear All Filters
                </button>
            </div>
        </div>

        <!-- Search Results -->
        <div x-show="searchResults.length > 0 || isSearching" class="mt-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-display text-lg text-arcanum-text">
                    <span x-show="!isSearching" x-text="searchResults.length + ' cards found'"></span>
                    <span x-show="isSearching" class="text-arcanum-muted">Searching...</span>
                </h3>
            </div>

            <!-- Results Grid -->
            <div x-show="!isSearching" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <template x-for="card in searchResults.slice(0, 20)" :key="card.id">
                    <div class="group relative bg-arcanum-deep rounded-lg overflow-hidden border border-arcanum-border hover:border-mana-gold/50 transition-all cursor-pointer"
                         @click="selectCard(card)">
                        <div class="aspect-[488/680] bg-arcanum-surface">
                            <img :src="card.image_url || 'https://cards.scryfall.io/normal/front/0/0/00000000-0000-0000-0000-000000000000.jpg'"
                                 :alt="card.name"
                                 class="w-full h-full object-cover"
                                 loading="lazy"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 488 680%27%3E%3Crect fill=%27%231a1a24%27 width=%27488%27 height=%27680%27/%3E%3Ctext x=%27244%27 y=%27340%27 text-anchor=%27middle%27 fill=%27%236b6b7b%27 font-size=%2724%27%3ENo Image%3C/text%3E%3C/svg%3E'">
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-arcanum-void via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="absolute bottom-0 left-0 right-0 p-3">
                                <p class="font-display text-sm text-white truncate" x-text="card.name"></p>
                                <p class="text-xs text-arcanum-muted" x-text="card.set_name || card.set"></p>
                            </div>
                        </div>
                        <!-- Rarity indicator -->
                        <div class="absolute top-2 right-2 w-3 h-3 rounded-full"
                             :class="{
                                 'bg-orange-500 shadow-[0_0_8px_rgba(255,107,53,0.8)]': card.rarity === 'mythic',
                                 'bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.8)]': card.rarity === 'rare',
                                 'bg-gray-400': card.rarity === 'uncommon',
                                 'bg-gray-600': card.rarity === 'common'
                             }"></div>
                    </div>
                </template>
            </div>

            <!-- Loading skeleton -->
            <div x-show="isSearching" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <template x-for="i in 10">
                    <div class="aspect-[488/680] bg-arcanum-deep rounded-lg shimmer"></div>
                </template>
            </div>
        </div>
    </section>

    <!-- Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">

        <!-- Profile & Deck Management -->
        <div class="lg:col-span-2 space-y-6">
            <div class="card-frame">
                <div class="px-4 sm:px-6 py-4 border-b border-arcanum-border flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div>
                        <h2 class="font-display text-lg sm:text-xl text-mana-gold">Spellbook Management</h2>
                        <p class="text-xs sm:text-sm text-arcanum-muted">Organize your proxy collections</p>
                    </div>
                    <button @click="showDeckImport = !showDeckImport"
                            class="w-full sm:w-auto px-4 py-2 text-sm font-display tracking-wide text-arcanum-text bg-arcanum-surface hover:bg-arcanum-elevated border border-arcanum-border rounded-lg transition-colors">
                        <span x-text="showDeckImport ? 'Cancel' : 'Import Deck'"></span>
                    </button>
                </div>

                <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                    <!-- Profile Selection -->
                    <div>
                        <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">SELECT PROFILE</label>
                        <select id="profileSelect" x-model="selectedProfile" @change="loadDecks()"
                                class="w-full px-3 sm:px-4 py-3 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text">
                            <option value="">Choose a profile...</option>
                        </select>
                    </div>

                    <!-- Deck Import Panel -->
                    <div x-show="showDeckImport" x-cloak x-transition class="p-4 bg-arcanum-deep/50 rounded-lg border border-mana-gold/20">
                        <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">PASTE DECK LIST</label>
                        <textarea x-model="deckImportText" rows="6" placeholder="4 Lightning Bolt&#10;4 Counterspell&#10;2 Island&#10;..."
                                  class="w-full px-4 py-3 bg-arcanum-void border border-arcanum-border rounded-lg text-arcanum-text placeholder-arcanum-muted text-sm"></textarea>
                        <div class="mt-3 flex gap-3">
                            <input type="text" id="importDeckName" placeholder="Deck name..."
                                   class="flex-1 px-4 py-2 bg-arcanum-void border border-arcanum-border rounded-lg text-arcanum-text text-sm">
                            <button @click="importDeck()"
                                    class="px-6 py-2 bg-gradient-to-r from-mana-gold to-amber-600 text-arcanum-void font-display text-sm tracking-wide rounded-lg btn-lift">
                                Import
                            </button>
                        </div>
                    </div>

                    <!-- Deck List -->
                    <div>
                        <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">DECK COLLECTION</label>
                        <div id="deckList" class="min-h-[200px] bg-arcanum-deep/30 rounded-lg border border-arcanum-border p-4">
                            <p class="text-sm text-arcanum-muted text-center py-8">Select a profile to view decks</p>
                        </div>
                    </div>

                    <!-- Create Deck -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="newDeckName" placeholder="New deck name..."
                               class="flex-1 px-3 sm:px-4 py-3 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text">
                        <button @click="createDeck()"
                                class="w-full sm:w-auto px-6 py-3 bg-arcanum-surface hover:bg-arcanum-elevated border border-arcanum-border text-arcanum-text font-display tracking-wide rounded-lg transition-colors">
                            Create Deck
                        </button>
                    </div>
                </div>
            </div>

            <!-- PDF Generation -->
            <div class="card-frame">
                <div class="px-4 sm:px-6 py-4 border-b border-arcanum-border">
                    <h2 class="font-display text-lg sm:text-xl text-mana-gold">Forge Proxies</h2>
                    <p class="text-xs sm:text-sm text-arcanum-muted">Generate print-ready PDF sheets</p>
                </div>

                <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">DECK</label>
                            <select id="deckSelect" x-model="selectedDeck"
                                    class="w-full px-4 py-3 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text">
                                <option value="">All cards</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-display text-arcanum-muted mb-2 tracking-wide">OUTPUT NAME</label>
                            <input type="text" id="pdfName" placeholder="Auto-generated"
                                   class="w-full px-4 py-3 bg-arcanum-deep border border-arcanum-border rounded-lg text-arcanum-text">
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <details class="group">
                        <summary class="cursor-pointer text-sm text-arcanum-muted hover:text-mana-gold transition-colors font-display tracking-wide list-none flex items-center gap-2 py-2">
                            <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                            Advanced Options
                        </summary>
                        <div class="mt-3 sm:mt-4 grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4 p-3 sm:p-4 bg-arcanum-deep/30 rounded-lg">
                            <div>
                                <label class="block text-xs text-arcanum-muted mb-1">Card Size</label>
                                <select id="cardSize" class="w-full px-3 py-2 bg-arcanum-void border border-arcanum-border rounded text-sm text-arcanum-text">
                                    <option value="standard">Standard</option>
                                    <option value="poker">Poker</option>
                                    <option value="bridge">Bridge</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-arcanum-muted mb-1">Paper</label>
                                <select id="paperSize" class="w-full px-3 py-2 bg-arcanum-void border border-arcanum-border rounded text-sm text-arcanum-text">
                                    <option value="letter">Letter</option>
                                    <option value="a4">A4</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-arcanum-muted mb-1">PPI</label>
                                <input type="number" id="ppi" value="600"
                                       class="w-full px-3 py-2 bg-arcanum-void border border-arcanum-border rounded text-sm text-arcanum-text">
                            </div>
                            <div>
                                <label class="block text-xs text-arcanum-muted mb-1">Crop (mm)</label>
                                <input type="number" id="crop" value="3" step="0.5"
                                       class="w-full px-3 py-2 bg-arcanum-void border border-arcanum-border rounded text-sm text-arcanum-text">
                            </div>
                            <div>
                                <label class="block text-xs text-arcanum-muted mb-1">Quality</label>
                                <input type="number" id="quality" value="100" min="50" max="100"
                                       class="w-full px-3 py-2 bg-arcanum-void border border-arcanum-border rounded text-sm text-arcanum-text">
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center gap-2 text-sm text-arcanum-text">
                                    <input type="checkbox" id="onlyFronts" class="rounded border-arcanum-border bg-arcanum-void text-mana-gold">
                                    Fronts only
                                </label>
                            </div>
                        </div>
                    </details>

                    <button @click="generatePDF()" :disabled="isGenerating"
                            :class="isGenerating ? 'opacity-50' : ''"
                            class="w-full py-4 bg-gradient-to-r from-mana-gold via-amber-500 to-mana-gold text-arcanum-void font-display text-lg tracking-wide rounded-lg btn-lift flex items-center justify-center gap-3">
                        <svg x-show="isGenerating" class="w-5 h-5 spinner" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                        </svg>
                        <span x-text="isGenerating ? 'Forging...' : 'Generate PDF'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-4 sm:space-y-6">
            <!-- System Status -->
            <div class="card-frame p-4 sm:p-6">
                <h3 class="font-display text-xs sm:text-sm text-arcanum-muted tracking-widest uppercase mb-3 sm:mb-4">System Status</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-arcanum-text">Database</span>
                        <span class="flex items-center gap-2 text-sm">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span class="text-green-400">Ready</span>
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-arcanum-text">Scryfall API</span>
                        <span class="flex items-center gap-2 text-sm">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span class="text-green-400">Connected</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Recent Tasks -->
            <div class="card-frame p-4 sm:p-6">
                <h3 class="font-display text-xs sm:text-sm text-arcanum-muted tracking-widest uppercase mb-3 sm:mb-4">Recent Tasks</h3>
                <div class="space-y-3" id="taskList">
                    {% for task in tasks[-5:] %}
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-arcanum-text truncate">{{ task.name }}</span>
                        <span class="px-2 py-1 rounded text-xs font-display tracking-wide
                                   {% if task.status == 'completed' %}bg-green-900/30 text-green-400{% elif task.status == 'running' %}bg-blue-900/30 text-blue-400{% else %}bg-red-900/30 text-red-400{% endif %}">
                            {{ task.status }}
                        </span>
                    </div>
                    {% else %}
                    <p class="text-sm text-arcanum-muted text-center py-4">No recent tasks</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card-frame p-4 sm:p-6">
                <h3 class="font-display text-xs sm:text-sm text-arcanum-muted tracking-widest uppercase mb-3 sm:mb-4">Quick Actions</h3>
                <div class="space-y-2">
                    <a href="/coverage" class="block w-full px-4 py-3 bg-arcanum-surface hover:bg-arcanum-elevated border border-arcanum-border rounded-lg text-center text-arcanum-text font-display text-sm tracking-wide transition-colors">
                        Coverage Reports
                    </a>
                    <a href="/unique_art" class="block w-full px-4 py-3 bg-arcanum-surface hover:bg-arcanum-elevated border border-arcanum-border rounded-lg text-center text-arcanum-text font-display text-sm tracking-wide transition-colors">
                        Unique Artwork
                    </a>
                    <a href="/admin" class="block w-full px-4 py-3 bg-arcanum-surface hover:bg-arcanum-elevated border border-arcanum-border rounded-lg text-center text-arcanum-text font-display text-sm tracking-wide transition-colors">
                        Admin Panel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div x-show="message" x-cloak x-transition
         class="fixed bottom-4 left-4 right-4 sm:left-auto sm:bottom-6 sm:right-6 z-50 sm:max-w-sm">
        <div :class="messageType === 'success' ? 'border-green-500/50 bg-green-900/20' : 'border-red-500/50 bg-red-900/20'"
             class="card-frame border-l-4 p-4 flex items-start gap-3">
            <svg x-show="messageType === 'success'" class="w-5 h-5 text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <svg x-show="messageType === 'error'" class="w-5 h-5 text-red-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <p class="text-sm text-arcanum-text" x-text="message"></p>
            <button @click="message = ''" class="ml-auto text-arcanum-muted hover:text-arcanum-text">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function dashboard() {
    return {
        // State
        selectedProfile: '',
        selectedDeck: '',
        message: '',
        messageType: '',
        isGenerating: false,
        showDeckImport: false,
        deckImportText: '',

        // Search state
        searchQuery: '',
        colors: [],
        cardType: '',
        rarity: '',
        cmc: '',
        setCode: '',
        showFilters: false,
        searchResults: [],
        isSearching: false,

        // Methods
        showMessage(text, type) {
            this.message = text;
            this.messageType = type;
            setTimeout(() => { this.message = ''; }, 5000);
        },

        toggleColor(color) {
            const idx = this.colors.indexOf(color);
            if (idx > -1) {
                this.colors.splice(idx, 1);
            } else {
                this.colors.push(color);
            }
            this.performSearch();
        },

        clearFilters() {
            this.colors = [];
            this.cardType = '';
            this.rarity = '';
            this.cmc = '';
            this.setCode = '';
            this.searchResults = [];
        },

        async performSearch() {
            if (!this.searchQuery && this.colors.length === 0 && !this.cardType && !this.rarity && !this.cmc && !this.setCode) {
                this.searchResults = [];
                return;
            }

            this.isSearching = true;

            const params = new URLSearchParams();
            if (this.searchQuery) params.set('q', this.searchQuery);
            if (this.colors.length) params.set('colors', this.colors.join(''));
            if (this.cardType) params.set('type', this.cardType);
            if (this.rarity) params.set('rarity', this.rarity);
            if (this.cmc) params.set('cmc', this.cmc);
            if (this.setCode) params.set('set', this.setCode);

            try {
                const res = await fetch(`/api/search/cards?${params}`);
                const data = await res.json();
                this.searchResults = data.cards || [];
            } catch (e) {
                this.showMessage('Search failed', 'error');
                this.searchResults = [];
            } finally {
                this.isSearching = false;
            }
        },

        selectCard(card) {
            // TODO: Open card detail modal or add to deck
            this.showMessage(`Selected: ${card.name}`, 'success');
        },

        init() {
            this.loadProfiles();
        },

        async loadProfiles() {
            try {
                const res = await fetch('/api/profiles');
                const data = await res.json();
                const select = document.getElementById('profileSelect');
                select.innerHTML = '<option value="">Choose a profile...</option>';
                (data.profiles || []).forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    opt.textContent = p.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load profiles:', e);
            }
        },

        async loadDecks() {
            const profile = this.selectedProfile;
            const list = document.getElementById('deckList');

            if (!profile) {
                list.innerHTML = '<p class="text-sm text-arcanum-muted text-center py-8">Select a profile to view decks</p>';
                return;
            }

            list.innerHTML = '<div class="flex justify-center py-8"><div class="w-8 h-8 border-2 border-mana-gold/30 border-t-mana-gold rounded-full spinner"></div></div>';

            try {
                const res = await fetch(`/api/profiles/${profile}/decks`);
                const data = await res.json();

                if (!data.decks || data.decks.length === 0) {
                    list.innerHTML = '<p class="text-sm text-arcanum-muted text-center py-8">No decks found. Create one below!</p>';
                } else {
                    let html = '<div class="space-y-2">';
                    data.decks.forEach(deck => {
                        html += `
                            <div class="flex items-center justify-between p-3 bg-arcanum-surface rounded-lg border border-arcanum-border hover:border-mana-gold/30 transition-colors group">
                                <div class="min-w-0 flex-1">
                                    <span class="font-display text-arcanum-text text-sm sm:text-base truncate block">${deck.name}</span>
                                    <span class="text-xs sm:text-sm text-arcanum-muted">${deck.card_count} cards</span>
                                </div>
                                <div class="flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity ml-2">
                                    <button onclick="viewDeck('${deck.name}')" class="p-2 text-arcanum-muted hover:text-mana-gold">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                }

                // Update deck select
                const deckSelect = document.getElementById('deckSelect');
                deckSelect.innerHTML = '<option value="">All cards</option>';
                (data.decks || []).forEach(deck => {
                    deckSelect.innerHTML += `<option value="${deck.name}">${deck.name} (${deck.card_count})</option>`;
                });
            } catch (e) {
                list.innerHTML = '<p class="text-sm text-red-400 text-center py-8">Failed to load decks</p>';
            }
        },

        async createDeck() {
            const deckName = document.getElementById('newDeckName').value.trim();
            if (!this.selectedProfile || !deckName) {
                this.showMessage('Select a profile and enter a deck name', 'error');
                return;
            }

            try {
                const res = await fetch(`/api/profiles/${this.selectedProfile}/decks`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({deck_name: deckName})
                });
                const data = await res.json();
                if (data.error) {
                    this.showMessage(data.error, 'error');
                } else {
                    this.showMessage(`Deck "${deckName}" created!`, 'success');
                    document.getElementById('newDeckName').value = '';
                    this.loadDecks();
                }
            } catch (e) {
                this.showMessage('Failed to create deck', 'error');
            }
        },

        async importDeck() {
            const deckName = document.getElementById('importDeckName').value.trim();
            if (!this.selectedProfile || !deckName || !this.deckImportText) {
                this.showMessage('Fill in all fields', 'error');
                return;
            }

            this.showMessage('Importing deck...', 'success');

            try {
                const res = await fetch(`/api/profiles/${this.selectedProfile}/import-deck`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({deck_name: deckName, deck_list: this.deckImportText})
                });
                const data = await res.json();
                if (data.error) {
                    this.showMessage(data.error, 'error');
                } else {
                    this.showMessage(`Imported "${deckName}"!`, 'success');
                    this.deckImportText = '';
                    document.getElementById('importDeckName').value = '';
                    this.showDeckImport = false;
                    this.loadDecks();
                }
            } catch (e) {
                this.showMessage('Import failed', 'error');
            }
        },

        async generatePDF() {
            if (!this.selectedProfile) {
                this.showMessage('Select a profile first', 'error');
                return;
            }

            this.isGenerating = true;

            const payload = {
                deck: document.getElementById('deckSelect').value || null,
                pdf_name: document.getElementById('pdfName').value.trim() || null,
                card_size: document.getElementById('cardSize').value,
                paper_size: document.getElementById('paperSize').value,
                crop: parseFloat(document.getElementById('crop').value),
                ppi: parseInt(document.getElementById('ppi').value),
                quality: parseInt(document.getElementById('quality').value),
                only_fronts: document.getElementById('onlyFronts').checked
            };

            try {
                const res = await fetch(`/api/profiles/${this.selectedProfile}/pdf`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.error) {
                    this.showMessage(data.error, 'error');
                } else {
                    this.showMessage('PDF generation started!', 'success');
                    setTimeout(() => location.reload(), 3000);
                }
            } catch (e) {
                this.showMessage('Failed to start generation', 'error');
            } finally {
                this.isGenerating = false;
            }
        }
    };
}

function viewDeck(name) {
    // TODO: implement deck viewer
    alert('View deck: ' + name);
}
</script>
{% endblock %}
