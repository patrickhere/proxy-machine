# Nginx configuration for self-hosted Proxy Machine data server
# Copy to: /etc/nginx/sites-available/proxy-data
# Enable with: sudo ln -s /etc/nginx/sites-available/proxy-data /etc/nginx/sites-enabled/

server {
    listen 80;
    listen [::]:80;

    # Replace with your domain or use _ for any hostname
    server_name your-domain.com;

    # Data directory
    root /var/www/proxy-data;

    # Logging
    access_log /var/log/nginx/proxy-data-access.log;
    error_log /var/log/nginx/proxy-data-error.log warn;

    # Enable directory listing (optional - disable in production)
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    # CORS headers (allow cross-origin requests)
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;
    add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

    # Handle OPTIONS requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS';
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
    }

    # Default cache headers
    expires 7d;
    add_header Cache-Control "public, immutable";

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        application/json
        application/octet-stream
        application/x-gzip
        image/jpeg
        image/png
        image/webp;
    gzip_min_length 1000;

    # Main location
    location / {
        try_files $uri $uri/ =404;
    }

    # Bulk data endpoint (longer cache)
    location /bulk-data/ {
        alias /var/www/proxy-data/bulk-data/;
        expires 30d;
        add_header Cache-Control "public, immutable";

        # Special handling for database file
        location ~ \.db$ {
            # Prevent direct download of database (optional)
            # return 403;

            # Or allow with shorter cache
            expires 1d;
        }
    }

    # Tokens endpoint
    location /tokens/ {
        alias /var/www/proxy-data/tokens/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Basic lands endpoint
    location /basic-lands/ {
        alias /var/www/proxy-data/basic-lands/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Non-basic lands endpoint
    location /non-basic-lands/ {
        alias /var/www/proxy-data/non-basic-lands/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Card backs endpoint
    location /card-backs/ {
        alias /var/www/proxy-data/card-backs/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # API manifest endpoint (optional)
    location /api/manifest {
        default_type application/json;
        return 200 '{
            "status": "ok",
            "endpoints": {
                "bulk_data": "/bulk-data/",
                "tokens": "/tokens/",
                "basic_lands": "/basic-lands/",
                "non_basic_lands": "/non-basic-lands/",
                "card_backs": "/card-backs/"
            },
            "files": {
                "all_cards": "/bulk-data/all-cards.json.gz",
                "oracle_cards": "/bulk-data/oracle-cards.json.gz",
                "unique_artwork": "/bulk-data/unique-artwork.json.gz",
                "database": "/bulk-data/bulk.db"
            }
        }';
    }

    # Rate limiting (optional - uncomment to enable)
    # limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    # limit_req zone=api_limit burst=20 nodelay;

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTPS configuration (after running certbot)
# Certbot will automatically add this block
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name your-domain.com;
#
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     # ... rest of configuration same as above ...
# }
